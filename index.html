<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ReachPoint</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./styles.css" />

    <!-- Small add-on styles for the mobile dropdown -->
    <style>
      /* Ensure anything with [hidden] is truly hidden, regardless of other rules */
      [hidden] { display: none !important; }

      /* Base: hide hamburger on wide screens */
      .menu-btn { display:none; }

      /* Mobile menu container (hidden by default via [hidden]) */
      .mobile-menu {
        position: absolute;
        right: 12px;
        top: 56px;          /* just below topbar */
        background: #ffffff;
        border: 1px solid #cbd5e1;
        border-radius: 12px;
        box-shadow: 0 12px 24px rgba(2,6,23,.12);
        padding: 8px;
        display: flex;
        flex-direction: column;
        min-width: 180px;
        z-index: 60;
      }
      .mobile-menu a {
        display: block;
        padding: 10px 12px;
        border-radius: 8px;
        text-decoration: none;
        color: #1d4ed8; /* ink */
        font-weight: 700;
      }
      .mobile-menu a:hover { background: #f1f5f9; }

      /* On small screens: hide desktop nav, show hamburger */
      @media (max-width: 720px) {
        header .nav { display: none; }
        .menu-btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          padding: 8px 10px;
          border-radius: 10px;
          border: 1px solid #cbd5e1;
          background: #e2e8f0;
          color: #0f172a;
          font-weight: 800;
          cursor: pointer;
        }
        .menu-btn:active { transform: translateY(1px); }
      }
    </style>

    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // ===== DEV ONLY: Inject your ReachPoint-dev credentials =====
      // NOTE: Use env vars / server proxy for prod builds.
      window.__SUPABASE_URL__ = "https://qmhxpugetaksrktyfmji.supabase.co";
      window.__SUPABASE_ANON_KEY__ = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtaHhwdWdldGFrc3JrdHlmbWppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NjA0NzYsImV4cCI6MjA3NDMzNjQ3Nn0.-pS4lHZKwxiVh3XL191_IMcZ-JvESva3zo2elTfSDGg";

      // Create a single shared Supabase client for the whole app.
      (function initSupabase() {
        try {
          const url = window.__SUPABASE_URL__;
          const key = window.__SUPABASE_ANON_KEY__;
          if (!url || !key) return;

          const client = supabase.createClient(url, key, {
            auth: {
              persistSession: true,
              autoRefreshToken: true
            },
            global: { headers: { "x-reachpoint-env": "dev" } },
          });

          window.supabase = client;
          window.hasSupabase = () => !!(window.supabase && typeof window.supabase.from === "function");
          console.log("[ReachPoint] Supabase client initialized:", window.hasSupabase());
        } catch (e) {
          console.error("[ReachPoint] Failed to init Supabase; local-only fallback.", e);
        }
      })();
    </script>
  </head>

  <body>
    <header class="topbar" style="position:sticky;top:0;z-index:50;">
      <div class="brand">ReachPoint</div>

      <!-- Hamburger button appears on small screens -->
      <button class="menu-btn"
              type="button"
              aria-label="Open Menu"
              aria-controls="mobileMenu"
              aria-expanded="false"
              aria-haspopup="menu">
        â˜° Menu
      </button>

      <!-- Desktop nav -->
      <nav class="nav">
        <a href="#/dashboard">Dashboard</a>
        <a href="#/create">New Campaign</a>
        <a href="#/call">Call Anyone</a>
        <a href="#/insights">Insights</a>
      </nav>

      <!-- Mobile dropdown menu -->
      <div id="mobileMenu" class="mobile-menu" role="menu" hidden inert></div>
    </header>

    <!-- App root -->
    <main id="app"></main>

    <!-- Default route BEFORE app loads -->
    <script>
      if (!location.hash || !/^#\//.test(location.hash)) {
        location.hash = "#/dashboard";
      }

      // === Mobile menu behavior (robust close-on-toggle & outside) ===
      (function mobileMenuInit() {
        const btn  = document.querySelector('.menu-btn');
        const menu = document.getElementById('mobileMenu');
        const srcNav = document.querySelector('header .nav');
        if (!btn || !menu || !srcNav) return;

        function openMenu() {
          syncMobileMenu();
          btn.setAttribute('aria-expanded', 'true');
          menu.hidden = false;
          menu.removeAttribute('inert');
        }
        function closeMenu() {
          btn.setAttribute('aria-expanded', 'false');
          menu.hidden = true;
          menu.setAttribute('inert', '');
        }
        function isOpen() {
          return btn.getAttribute('aria-expanded') === 'true';
        }

        // Clone the current links from the desktop nav into the mobile menu
        function syncMobileMenu() {
          menu.innerHTML = '';
          srcNav.querySelectorAll('a').forEach(a => {
            const clone = a.cloneNode(true);
            clone.setAttribute('role', 'menuitem');
            menu.appendChild(clone);
          });
        }

        // Keep mobile menu in sync when app.js injects/removes nav items (e.g., Logout)
        const obs = new MutationObserver(() => {
          if (isOpen()) syncMobileMenu();
        });
        obs.observe(srcNav, { childList: true, subtree: true });

        // Toggle open/close from button
        btn.addEventListener('click', () => (isOpen() ? closeMenu() : openMenu()));

        // Close on link click (route change)
        menu.addEventListener('click', (e) => {
          const a = e.target.closest('a[href^="#/"]');
          if (!a) return;
          closeMenu();
        });

        // Close when hash changes (navigated programmatically)
        window.addEventListener('hashchange', closeMenu);

        // Close if viewport gets large again
        window.addEventListener('resize', () => {
          if (window.innerWidth > 720) closeMenu();
        });

        // Close on Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && isOpen()) closeMenu();
        });

        // Close on outside tap/click (use pointerdown for mobile reliability)
        document.addEventListener('pointerdown', (e) => {
          if (menu.hidden) return;
          const insideMenu = menu.contains(e.target);
          const onButton   = btn.contains(e.target);
          if (!insideMenu && !onButton) closeMenu();
        });
      })();
    </script>

    <!-- Your app bundle -->
    <script type="module" src="./app.js"></script>
  </body>
</html>
